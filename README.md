# ì„œë¹„ìŠ¤ ì†Œê°œ

<aside>
ğŸ’¡ MarketHub
</aside>

- ë°±ë§Œê±´ ì´ìƒì˜ ëŒ€ìš©ëŸ‰ íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•˜ëŠ” ì´ì»¤ë¨¸ìŠ¤ ì‡¼í•‘ëª°

íŒ€ í”„ë¡œì íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì§€ì†ì ìœ¼ë¡œ ê°œì„ í•´ ë‚˜ê°€ê¸° ìœ„í•œ ê°œì¸ ë¦¬í¬ì§€í† ë¦¬ ì…ë‹ˆë‹¤. 

ê¸°ì¡´ íŠ¸ëŸ¬ë¸” ìŠˆíŒ…ê³¼ ê¸°ìˆ ì  ì˜ì‚¬ê²°ì •ì˜ ê²½ìš° ì•„ë˜ í”„ë¡œì íŠ¸ ë¦¬í¬ì§€í† ë¦¬ Read.me ì°¸ê³  ë¶€íƒë“œë¦½ë‹ˆë‹¤. 

ì„±ëŠ¥ ê°œì„  ì‚¬í•­ì€ ê¸°ìˆ  ë¸”ë¡œê·¸ì—ë„ ì‘ì„± ì¤‘ì´ë‹ˆ, í¸í•˜ê²Œ ì½ìœ¼ì‹œë ¤ë©´ ì•„ë˜ ë¸”ë¡œê·¸ ë°©ë¬¸ ë¶€íƒë“œë¦¬ê² ìŠµë‹ˆë‹¤.

â€£https://blog.naver.com/wodnrtkfka

---
## ğŸ¥ƒ Github ì£¼ì†Œ

â€£https://github.com/hanghae-markethub/markethub

## ğŸ¥ƒ íŒ€ ë…¸ì…˜ ì£¼ì†Œ

[Market Hub](https://www.notion.so/Market-Hub-890957603b8d47249b5a1e469328d8ae?pvs=21) 

---

# ì„±ëŠ¥ ê°œì„  ì •ë¦¬ ğŸ‘‡

<summary>1. Purchase Entityì— Indexë¥¼ ë„ì…í•˜ì—¬ ì¡°íšŒ ì„±ëŠ¥ì„ ë†’í˜€ë³´ì.!</summary>
<details>
- MySQLì˜ ê²½ìš° ì•„ë˜ì™€ ê°™ì€ ì´ìœ ë¡œ ì¸í•´ PKì— ìë™ìœ¼ë¡œ Indexê°€ ê±¸ë ¤ ìˆìŠµë‹ˆë‹¤.

```  
ë°ì´í„° ê²€ìƒ‰ ì„±ëŠ¥ í–¥ìƒ: 
ê¸°ë³¸í‚¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê²€ìƒ‰í• ë•Œ ì„±ëŠ¥ì‘ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•´

ê³ ìœ ì„± ë³´ì¥: 
ê¸°ë³¸ í‚¤ëŠ” í…Œì´ë¸”ì—ì„œ ê° ë ˆì½”ë“œë¥¼ ê³ ìœ í•˜ê²Œ ì‹ë³„í•˜ëŠ” ë° ì‚¬ìš©í•œë‹¤.
ì¤‘ë³µëœ ê°’ì„ í—ˆìš©í•˜ì§€ ì•ŠëŠ” ê¸°ë³¸ í‚¤ë¥¼ ì¸ë±ìŠ¤ë¡œ ì„¤ì •í•¨ìœ¼ë¡œì„œ ë°ì´í„° ë¬´ê²°ì„±ì„ ë³´ì¥í•œë‹¤.

ë°ì´í„° ì •ë ¬: 
ë°ì´í„°ëŠ” ê¸°ë³¸ í‚¤ì˜ ì¸ë±ìŠ¤ì— ë”°ë¼ ì •ë ¬ëœë‹¤. 
ë”°ë¼ì„œ íŠ¹ì • ìˆœì„œë¡œ ë°ì´í„°ì— ì•¡ì„¸ìŠ¤í•˜ëŠ” ì¿¼ë¦¬ì˜ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤.

ì¡°ì¸ ë° ì •ë ¬ì˜ íš¨ìœ¨ì„±: 
ê¸°ë³¸ í‚¤ì— ëŒ€í•œ ì¸ë±ìŠ¤ëŠ” ì¡°ì¸ ë° ì •ë ¬ ì‘ì—…ì˜ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¨ë‹¤.
```

ì œê°€ ë‹´ë‹¹í•œ Purchase ë„ë©”ì¸ì˜ ê²½ìš° ì¡°íšŒê°€ ë°œìƒí•˜ëŠ” ê²½ìš°ì˜ ìˆ˜ëŠ” ì•„ë˜ ë‘ê°œì…ë‹ˆë‹¤.

1. ìœ ì €ê°€ ì•„ì´í…œì„ ì£¼ë¬¸ í•˜ê¸° ì „ ì£¼ë¬¸ì„œ
2. ìœ ì €ê°€ ì•„ì´í…œì„ ì£¼ë¬¸ í•œ í›„ ì£¼ë¬¸ì„œ

ê°ê°ì˜ ê²½ìš° Emailê³¼ Statusë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡°íšŒí•˜ì—¬ ê°€ì ¸ì˜¤ê²Œ ë©ë‹ˆë‹¤.

```
@Transactional(readOnly = true)
public List<PurchaseResponseDto> findAllPurchaseByEmail(String email) {
  List<Purchase> purchase = purchaseRepository.findByStatusAndEmailOrder(Status.EXIST,email);
        if (purchase == null) {
            throw new EntityNotFoundException("Purchase not found for email: " + email);
        }
        return PurchaseResponseDto.fromListPurchaseEntity(purchase);
    }
```

ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•´ Indexë¥¼ ì°¾ì•„ ë³´ë©´ì„œ ì²˜ìŒì—ëŠ” Emailì„ ê¸°ì¤€ìœ¼ë¡œ ê²€ìƒ‰ì„ í•˜ë‹ˆê¹Œ
emailì— ì¸ë±ìŠ¤ë¥¼ ê±¸ë©´ ì„±ëŠ¥ì´ í–¥ìƒë ê²ƒì´ë‹¤ ë¼ëŠ” ìƒê°ì„ í•˜ê²Œ ë˜ì—ˆê³ 

ì´ëŠ” ì¢‹ì§€ì•Šì€ ê²°ê³¼ë¥¼ ì´ˆë˜í–ˆìŠµë‹ˆë‹¤.

purchase ë„ë©”ì¸ì˜ íŠ¹ì„±ìƒ email ì»¬ëŸ¼ì˜ ê²½ìš° ì¤‘ë³µì´ ì¦ì€ í¸ì´ê¸°ì—
emailì— ì¸ë±ìŠ¤ë¥¼ ê±´ë‹¤ë©´ DBì˜ í¬ê¸°ë³´ë‹¤ ì¸ë±ìŠ¤ì˜ í¬ê¸°ê°€ ë” ì»¤ì§€ëŠ” ì˜¤ë²„í—¤ë“œ í˜„ìƒì´ ë°œìƒí•œ ê²ƒ ì…ë‹ˆë‹¤.

ê·¸ë¡œì¸í•´ ì–´ë–»ê²Œ í•˜ë©´ í•´ê²° í•  ìˆ˜ ìˆì„ê¹Œ ë¼ëŠ” ìƒê°ì„ í•˜ë˜ ì¤‘,
ë³µí•© ì¸ë±ìŠ¤ë¼ëŠ” ê°œë…ì„ ì°¾ì„ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

Emailê³¼ Statusë¥¼ í•¨ê»˜ ì¸ë±ì‹±í•˜ì—¬ ì¡°íšŒí•˜ë©´ ë¡œì§ ìƒ ì–´ë–¤ ê²½ìš°ì—ì„œë„ ì¤‘ë³µëœ ê°’ì¤‘ í•˜ë‚˜ë¥¼ ê³ ë¥´ëŠ” ê²½ìš°ê°€ ì—†ê³ ,
Emailê³¼ Statusë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê²€ìƒ‰í•œ ëª¨ë“  ê°’ì„ í•­ìƒ ì „ë¶€ ë³´ì—¬ì£¼ê¸°ë•Œë¬¸ì—

ì˜¤ë²„í—¤ë“œë¬¸ì œë¥¼ í•´ê²° í•  ìˆ˜ ìˆê³  ë” ë‚˜ì•„ê°€ ì„±ëŠ¥ì´ ê°œì„ ë ê±°ë€ ì˜ˆìƒì´ ë“¤ì—ˆìŠµë‹ˆë‹¤.
    
![image](https://github.com/naraspc/markethubTestRepo/assets/140101271/bfbae8d6-e3ca-4084-b37f-d4125a676db5)

ì´ë ‡ê²Œ ê°ê°ì˜ ì»¬ëŸ¼ì— ì¸ë±ìŠ¤ë¥¼ ê±¸ì–´ì£¼ì—ˆìŠµë‹ˆë‹¤.

ì„±ëŠ¥ì´ ì–¼ë§ˆë‚˜ ê°œì„ ë˜ì—ˆëŠ”ì§€ í™•ì¸ í•´ ë³´ê² ìŠµë‹ˆë‹¤.
![image](https://github.com/naraspc/markethubTestRepo/assets/140101271/ad50d9ee-b07d-44d1-a980-aa9d27434d4e)
ì¸ë±ìŠ¤ì˜ ì ìš© ì „ 6.8ì´ˆì˜ ì‹œê°„ì´ ì†Œìš”ë˜ì—ˆê³ ,

ì ìš© í›„

![image](https://github.com/naraspc/markethubTestRepo/assets/140101271/9b654cf5-6f77-46e3-b2d0-f24edbf3a266)

3.8ì´ˆê°€ ì†Œìš”ë˜ì—ˆìŠµë‹ˆë‹¤.

ë§Œì•½ ë°ì´í„°ê°€ ë” ë§ì•„ì§„ë‹¤ë©´ ë”ë”ìš± ë‘ë“œëŸ¬ì§€ê²Œ ê²°ê³¼ê°€ ë‚˜íƒ€ë‚ ê²ƒì´ë¼ê³  íŒë‹¨ë©ë‹ˆë‹¤.

ì¶”ê°€ë¡œ, MySQLì—ì„œ ì‚¬ìš©í•˜ëŠ” ìŠ¤í† ë¦¬ì§€ ì—”ì§„ì¸ InnoDBì˜ ê²½ìš°

updateì¿¼ë¦¬ê°€ ë‚ ì•„ì™”ì„ë•Œ indexë¥¼ ì „ë¶€ ì ê¶ˆë²„ë¦½ë‹ˆë‹¤.

ì˜ˆë¥¼ë“¤ì–´ purchase ì—”í‹°í‹°ì—ì„œ ì´ë©”ì¼ë§Œ ì¸ë±ìŠ¤ë¡œ ì²˜ë¦¬ë¥¼ í–ˆë‹¤ê³  ê°€ì •í•´ë´…ì‹œë‹¤.
ê·¸ë¦¬ê³ , test@test.com ì´ë©”ì¼ì˜ ê°’ì„ ë°”ê¾¸ëŠ” ì¿¼ë¦¬ë¥¼ ë‚ ë ¸ë‹¤ê³  ê°€ì •í•´ë´…ì‹œë‹¤.

test ì´ë©”ì¼ ë°ì´í„°ê°€ 1000ê°œê°€ ìˆë‹¤ë©´ 1000ê°œì˜ ë°ì´í„° ëª¨ë‘ê°€ ì ê¸°ê²Œë©ë‹ˆë‹¤..

ë§Œì•½ purchase í…Œì´ë¸”ì— ë°ì´í„°ê°€ 10ë§Œê°œê°€ ìˆê³ , ì¸ë±ìŠ¤ë¥¼ ë”°ë¡œ ê±¸ì–´ì£¼ì§€ ì•Šì•˜ë‹¤ë©´
test@test.com ì´ë©”ì¼ì˜ ë³€ê²½ì‚¬í•­ì´ ì™„ë£Œë ë•Œê¹Œì§€ 10ë§Œê°œì˜ ë°ì´í„°ê°€ ì „ë¶€ lockê±¸ë ¤ë²„ë¦¬ê²Œ ë©ë‹ˆë‹¤..

ì¦‰, íš¨ìš¸ì ìœ¼ë¡œ InnoDBë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„ 
ì¸ë±ìŠ¤ë¥¼ ì‹ ì¤‘í•˜ê²Œ ê·¸ë¦¬ê³  ì ì ˆí•˜ê²Œ ê±¸ì–´ì¤˜ì•¼í•œë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

</details>

<summary>2. AOPë¥¼ ì ìš©í•˜ì—¬ ê³µí†µ ê´€ì‹¬ì‚¬ë¥¼ ë¶„ë¦¬í•´ë³´ì!</summary>
<details>
  AOPë€ ê´€ì‹¬ì‚¬ ë¶„ë¦¬ ê¸°ë²•ìœ¼ë¡œ,

ì£¼ëœ ëª©í‘œë¥¼ ê°€ì§€ëŠ” ê°ê°ì˜ í´ë˜ìŠ¤ë“¤ì˜ ë¶€ê°€ì ì¸ ê´€ì‹¬ì‚¬ë¥¼ ë”°ë¡œ ë¶„ë¦¬í•´ë‚´ëŠ” ê¸°ë²•ì´ë‹¤.

ì¦‰, A,B,Cë¼ëŠ” ëª…í™•í•œ ëª©ì ì„ ê°€ì§„ í´ë˜ìŠ¤ë“¤ì—ì„œ

ì´ ëª¨ë“  í´ë˜ìŠ¤ë“¤ì˜ í˜¸ì¶œì‹œê°„ì´ë¼ë˜ì§€ ë“±ì„ ì²´í¬í•˜ê³ ì‹¶ì„ë•Œ

ëª¨ë“  í´ë˜ìŠ¤ì— í˜¸ì¶œì‹œê°„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë¡œì§ì„ ì‘ì„±í•˜ë©´ ë˜ê²Œ ë²ˆê±°ë¡­ê³ ,
íš¨ìœ¨ë„ ë–¨ì–´ì§€ê³  í•´ë‹¹ í´ë˜ìŠ¤ì˜ ëª©ì ê³¼ ë§ì§€ì•ŠëŠ” ê¸°ëŠ¥ì´ ë ê²ƒì´ê¸°ì— ë”°ë¡œ AOPë¡œ ë¹¼ì„œ ì¸í„°ì…‰íŠ¸í•˜ê²Œ êµ¬í˜„í•œê±°ê°™ë‹¤

ì‘ì„±ë°©ë²•ì€ ë˜ê²Œ ê°„ë‹¨í•˜ë‹¤!
```
@Aspect
@Component
public class TimeTraceAop {

    @Around("execution(* org..hanghae..markethub..domain..*(..))")
    public Object execute(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {
        long start = System.currentTimeMillis();
        Object result = proceedingJoinPoint.proceed();
        long end = System.currentTimeMillis();
        System.out.println("Time : " + (end - start));
        return result;
    }

}
```

ìœ„ì˜ ì†ŒìŠ¤ì½”ë“œì²˜ëŸ¼ @Aspect ë¥¼ ì„ ì–¸í•˜ì—¬ í•´ë‹¹ í´ë˜ìŠ¤ê°€ AOPì„ì„ ì„ ì–¸í•´ì£¼ê³ ,

@Component ë¥¼ ì„ ì–¸í•´ì„œ ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ì„ ì ìš©í•˜ì

ì´í›„ ì›í•˜ëŠ” ë©”ì†Œë“œë¥¼ ì •ì˜í•˜ê³ , ê·¸ ìœ„ì— @Around ì–´ë…¸í…Œì´ì„ ì„ ì„ ì–¸í•´ì„œ ë²”ìœ„ë¥¼ ì§€ì •í•´ì£¼ì.

í•´ë‹¹ í”„ë¡œì íŠ¸ì˜ ê²½ìš° domainì•ˆì— ìˆëŠ” ë¡œì§ë“¤ë§Œ í™•ì¸í•˜ê³  ì‹¶ì–´ì„œ
org..hanghae..markethub..domain..

ê²½ë¡œë¡œ ì‘ì„±í–ˆë‹¤.
ë§Œì•½ ê²½ë¡œë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•˜ê³  ì‹¶ë‹¤ë©´ êµ¬ê¸€ë§ì„ í†µí•´ì„œ ì›í•˜ëŠ” ëŒ€ë¡œ ì»¤ìŠ¤í„°ë§ˆì´ì§•ì„ í•˜ì.

![image](https://github.com/naraspc/markethubTestRepo/assets/140101271/9eac94e9-2443-4acb-9d37-d3fb788e8424)
ì˜ ì‘ë™í•¨ì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤

</details>


<summary>3. DIPë¥¼ ì¤€ìˆ˜í•˜ëŠ” í• ì¸ì •ì±…ì„ êµ¬í˜„í•´ë³´ì!</summary>
<details>
ë©¤ë²„ì˜ ë“±ê¸‰ì— ë”°ë¼ í• ì¸ì„ ì°¨ë“±ì ìš© í•´ë³´ì!

ìš°ì„  discount íŒ¨í‚¤ì§€ë¥¼ ì‘ì„±í•´ì£¼ì.
![image](https://github.com/naraspc/markethubTestRepo/assets/140101271/a5b34597-7e48-4e09-a2dd-4647dc539b9a)


ì´í›„ DiscountPolicy Interfaceì™€ FixDiscountPolicyë¥¼ ì •ì˜í•´ì£¼ì.

```
public interface DiscountPolicy {
    /*
     * @return í• ì¸ ëŒ€ìƒ ê¸ˆì•¡
     */
    BigDecimal discount (User user, BigDecimal price);
}


@Service
public class FixDiscountPolicy implements DiscountPolicy{

    private BigDecimal discountFixAmount = new BigDecimal(100);
    @Override
    public BigDecimal discount(User user, BigDecimal price) {
        if (user.getRole().equals(Role.USER)) {
            return price.subtract(discountFixAmount);
        }
        return BigDecimal.ZERO;
    }
}
```
ë‚˜ëŠ” Purchase entityì—ì„œ ê¸ˆì•¡ì„ BigDecimal íƒ€ì…ìœ¼ë¡œ ì‚¬ìš©í•˜ê³ ìˆì–´ì„œ ì´ë ‡ê²Œ ì •ì˜í–ˆë‹¤.

ì´í›„, ìœ ì €ê°€ ì£¼ë¬¸í–ˆì„ë•Œ purchase ì—”í‹°í‹°ì˜ ìƒì„±ë¶€ë¶„ì„

```
    private final PurchaseRepository purchaseRepository;
    private final ItemService itemService;
    private final DiscountPolicy discountPolicy = new FixDiscountPolicy();
    private final UserRepository userRepository;
    
    @Transactional
    public PurchaseResponseDto createOrder(PurchaseRequestDto purchaseRequestDto, String email) {

        List<Purchase> existingPurchases = purchaseRepository.findAllByStatusAndEmail(Status.EXIST, email);
        // ì¡°íšŒëœ êµ¬ë§¤ê±´ ì‚­ì œ
        checkListPurchaseExist(existingPurchases);

        Purchase purchase = Purchase.builder()
                .status(purchaseRequestDto.status())
                .email(email)
                .itemName(purchaseRequestDto.itemName())
                .quantity(purchaseRequestDto.quantity())
                .price(discountPolicy.discount(userRepository.findByEmail(email).orElseThrow(() -> new EntityNotFoundException("can't find user")),purchaseRequestDto.price()))
                .itemId(purchaseRequestDto.itemId())
                .build();

        purchaseRepository.save(purchase);
        return PurchaseResponseDto.fromPurchase(purchase);

    }
```
ìë°”ì˜ ë‹¤í˜•ì„±ì„ í™œìš©í•´ private final DiscountPolicy discountPolicy = new FixDiscountPolicy();
ì´ëŸ°ì‹ìœ¼ë¡œ ì–¸ì œë“  í• ì¸ì •ì±…ì„ ë³€ê²½í•´ì„œ ê°ˆì•„ë¼ìš¸ ìˆ˜ ìˆë„ë¡ ì‘ì„±í–ˆë‹¤!

/* í† ë§‰ìƒì‹
* ìë°”ì˜ ë‹¤í˜•ì„±ì€ ê¸°ë³¸ì ìœ¼ë¡œ overwriteëœ ë©”ì†Œë“œë¥¼ ìš°ì„ ì‹œí•˜ì—¬ ì‹¤í–‰í•œë‹¤!
* ë˜í•œ ìì‹ë¶€í„° ì‹œì‘í•´ ì œì¼ ìœ„ì˜ ë¶€ëª¨ê¹Œì§€ ë‹¤ ë¶ˆëŸ¬ì˜¨ë‹¤.
*/

ì´ì œ userë“±ê¸‰ì˜ íšŒì›ê³¼ Admin ë“±ê¸‰ì˜ íšŒì›ìœ¼ë¡œ ê°ê° ì£¼ë¬¸ì‹ ì²­ì„ í•´, ê°€ê²©ì´ ì–´ë–»ê²Œ ë“¤ì–´ì˜¤ëŠ”ì§€ í™•ì¸í•´ë³´ì
![image](https://github.com/naraspc/markethubTestRepo/assets/140101271/5e9e81a0-9695-44d9-b077-8721bba6c4b4)
21000ì›ì§œë¦¬ ì¹˜í‚¨ êµ¬ë§¤ ì‹œ(ì‚¬ì§„ì€ ë¡œì»¬í™˜ê²½ì—ì„œ ì •ë¦¬í•˜ë‹¤ ìœ ì‹¤ëë‹¤.. ì–‘í•´ë°”ëŒ)

![image](https://github.com/naraspc/markethubTestRepo/assets/140101271/f56eb655-060b-4a34-9a56-b0a7c5a09441)

20,900ì› ìœ¼ë¡œ 100ì› í• ì¸ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

ì´ì œ Admin ê³„ì •ìœ¼ë¡œ í™•ì¸í•´ë³¼ê¹Œ?
![image](https://github.com/naraspc/markethubTestRepo/assets/140101271/2f7298cd-7b99-491f-b9e0-ae13b6047ea5)

ê°œì¸ì •ë³´ëŠ” ê°€ë ¸ë‹¤.
ê¸°ëŒ€í•œ ëŒ€ë¡œ ì˜ ì‘ë™í•¨ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤!


ì´ì   êµ¬ë§¤í•œ ìƒí’ˆ ê°€ê²©ì˜ 10%ë¥¼ í• ì¸í•´ì£¼ëŠ” í• ì¸ ì •ì±…ì„ ë§Œë“¤ì–´ë³´ì!

public class RateDiscountPolicy implements DiscountPolicy{
    @Override
    public BigDecimal discount(User user, BigDecimal price) {
        BigDecimal discount = new BigDecimal(10);
        if (user.getRole().equals(Role.USER)) {
            return price.subtract(price.divide(discount,1, RoundingMode.HALF_EVEN));
        }
        return BigDecimal.ZERO;
    }
}


í• ì¸ì •ì±…ì„ ë§Œë“¤ì—ˆë‹¤!

ì´ì œ ëª¨ë“ˆì„ ê°ˆì•„ ê»´ ë³´ì.

@Service
@RequiredArgsConstructor
public class PurchaseService {

    private final PurchaseRepository purchaseRepository;
    private final ItemService itemService;
    private final DiscountPolicy discountPolicy = new RateDiscountPolicy();
    private final UserRepository userRepository;

    @Transactional
    public PurchaseResponseDto createOrder(PurchaseRequestDto purchaseRequestDto, String email) {

        List<Purchase> existingPurchases = purchaseRepository.findAllByStatusAndEmail(Status.EXIST, email);
        // ì¡°íšŒëœ êµ¬ë§¤ê±´ ì‚­ì œ
        checkListPurchaseExist(existingPurchases);

        Purchase purchase = Purchase.builder()
                .status(purchaseRequestDto.status())
                .email(email)
                .itemName(purchaseRequestDto.itemName())
                .quantity(purchaseRequestDto.quantity())
                .price(discountPolicy.discount(userRepository.findByEmail(email).orElseThrow(() -> new EntityNotFoundException("can't find user")),purchaseRequestDto.price()))
                .itemId(purchaseRequestDto.itemId())
                .build();

        purchaseRepository.save(purchase);
        return PurchaseResponseDto.fromPurchase(purchase);

    }
ë‹¤ë¥¸ ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€í•œì±„
private final DiscountPolicy discountPolicy = new RateDiscountPolicy();

ì´ ë¶€ë¶„ë§Œ ê°ˆì•„ë¼ì›Œë³´ì•˜ë‹¤.
![image](https://github.com/naraspc/markethubTestRepo/assets/140101271/d073304d-9c77-4307-a366-21492335b534)

ì •ìƒì ìœ¼ë¡œ 10% í• ì¸ë˜ëŠ” ëª¨ìŠµì„ ë³¼ ìˆ˜ ìˆì—ˆë‹¤.

ì´ë˜ì„œ êµ¬í˜„ì„ ì‚¬ìš©í•˜ëŠ”êµ¬ë‚˜. í•œê°€ì§€ì˜ ê¹¨ë‹¬ìŒì„ ì–»ì„ ìˆ˜ ìˆì—ˆë‹¤.


// 2024 03 23 ì¶”ê°€
```
@Service
@RequiredArgsConstructor
public class PurchaseService {

    private final PurchaseRepository purchaseRepository;
    private final ItemService itemService;
    private final DiscountPolicy discountPolicy = new RateDiscountPolicy();
    private final UserRepository userRepository;

    @Transactional
    public PurchaseResponseDto createOrder(PurchaseRequestDto purchaseRequestDto, String email) {

        List<Purchase> existingPurchases = purchaseRepository.findAllByStatusAndEmail(Status.EXIST, email);
        // ì¡°íšŒëœ êµ¬ë§¤ê±´ ì‚­ì œ
        checkListPurchaseExist(existingPurchases);

        Purchase purchase = Purchase.builder()
                .status(purchaseRequestDto.status())
                .email(email)
                .itemName(purchaseRequestDto.itemName())
                .quantity(purchaseRequestDto.quantity())
                .price(discountPolicy.discount(userRepository.findByEmail(email).orElseThrow(() -> new EntityNotFoundException("can't find user")),purchaseRequestDto.price()))
                .itemId(purchaseRequestDto.itemId())
                .build();

        purchaseRepository.save(purchase);
        return PurchaseResponseDto.fromPurchase(purchase);

    }
```

ìœ„ ì½”ë“œë¥¼ ë³´ë©´ ë‚˜ëŠ” DIPë¥¼ ì¤€ìˆ˜í•˜ê³ ìˆì§€ ì•Šì•˜ë‹¤!

ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  ê·¸ë•Œê·¸ë•Œ ê°ˆì•„ë¼ë©´ì„œ ì˜ì¡´ì„±ì„ ì œê±°í•œì¤„ ì•Œì•˜ëŠ”ë°

ìƒê°í•´ë³´ë‹ˆ New RateDiscountPolicyë¥¼ ì„ ì–¸í•œ ìˆœê°„ êµ¬í˜„ì²´ë¥¼ ë™ì‹œì— ì„ ì–¸í•œê±°ì˜€ë‹¤.


```
@Service
@RequiredArgsConstructor
public class PurchaseService {

    private final PurchaseRepository purchaseRepository;
    private final ItemService itemService;
    private final DiscountPolicy discountPolicy;
    private final UserRepository userRepository;



    @Transactional
    public PurchaseResponseDto createOrder(PurchaseRequestDto purchaseRequestDto, String email) {

        List<Purchase> existingPurchases = purchaseRepository.findAllByStatusAndEmail(Status.EXIST, email);
        // ì¡°íšŒëœ êµ¬ë§¤ê±´ ì‚­ì œ
        checkListPurchaseExist(existingPurchases);

        Purchase purchase = Purchase.builder()
                .status(purchaseRequestDto.status())
                .email(email)
                .itemName(purchaseRequestDto.itemName())
                .quantity(purchaseRequestDto.quantity())
                .price(discountPolicy.discount(userRepository.findByEmail(email).orElseThrow(() -> new EntityNotFoundException("can't find user")),purchaseRequestDto.price()))
                .itemId(purchaseRequestDto.itemId())
                .build();

        purchaseRepository.save(purchase);
        return PurchaseResponseDto.fromPurchase(purchase);

    }
```
ì½”ë“œë¥¼ ì´ë ‡ê²Œ ìˆ˜ì •í•˜ê³ 
```
package org.hanghae.markethub.domain.discount;

import org.hanghae.markethub.domain.user.entity.User;
import org.hanghae.markethub.global.constant.Role;
import org.springframework.context.annotation.Primary;
import org.springframework.stereotype.Component;

import java.math.BigDecimal;
import java.math.RoundingMode;

@Primary
@Component
public class RateDiscountPolicy implements DiscountPolicy{
    @Override
    public BigDecimal discount(User user, BigDecimal price) {
        BigDecimal discount = new BigDecimal(10);
        if (user.getRole().equals(Role.USER)) {
            return price.subtract(price.divide(discount,1, RoundingMode.HALF_EVEN));
        }
        return BigDecimal.ZERO;
    }
}
```
@Primaryë¥¼ ì„ ì–¸í•´ì£¼ë„ë¡ í•˜ì.

@PrimaryëŠ” ë¹ˆ ìŠ¤ìº”ì˜ ìš°ì„ ìˆœìœ„ë¥¼ ë¶€ì—¬í•´ì¤€ë‹¤.

</details>

---

# íŠ¸ëŸ¬ë¸” ìŠˆíŒ… ì •ë¦¬ ğŸ‘‡


<summary>1. DIPì™€ AOPì˜ ì¶©ëŒ</summary>
<details>
ê¸°ì¡´ PaymentController ì½”ë“œë¥¼ DIPë¥¼ ìœ„ë°°í•˜ì§€ì•Šê²Œ ë¦¬íŒ©í† ë§ì„ ì§„í–‰í•˜ë©´ì„œ í•˜ë‚˜ì˜ ì´ìŠˆì™€ ë§ë‹¥ë“¤ì´ê²Œ ë˜ì—ˆë‹¤.


ê¸°ì¡´ì½”ë“œ
```
@RestController
@Slf4j
@RequiredArgsConstructor
public class PaymentController {

    // test init
    private final PurchaseService purchaseService;
    private final ItemService itemService;
    private IamportClient iamportClient;
    private final RedissonClient redissonClient; // Redisson í´ë¼ì´ì–¸íŠ¸ ì£¼ì…
    private final JwtUtil jwtUtil;

    //2ì›” 29ì¼ ì‘ì—…ëª©ë¡ 1. ì‹œí¬ë¦¿í‚¤, apií‚¤ ë³€ìˆ˜í™”
    @Value("${secret.sec.key}")
    private String secretKey ;
    @Value("${api.api.key}")
    private String apiKey ;

    @PostConstruct
    public void init() {
        this.iamportClient = new IamportClient(apiKey, secretKey);
    }
```
ì´ëŸ°ì‹ìœ¼ë¡œ, DIPë¥¼ ì¤€ìˆ˜í•˜ëŠ”ë“¯ í•˜ì˜€ìœ¼ë‚˜ PaymentController (ê³ ìˆ˜ì¤€ ëª¨ë“ˆ)ì—ì„œ
IamportClient(ì €ìˆ˜ì¤€ ëª¨ë“ˆ)ë¥¼ ì§ì ‘ ì£¼ì…í•˜ëŠ” í˜•ì‹ì„ ì·¨í•´

DIPë¥¼ ìœ„ë°°í•˜ê³ ìˆì—ˆë‹¤.

ì´ë¥¼

```
@RestController
@Slf4j
@RequiredArgsConstructor
public class PaymentController {

    // test init
    private final PurchaseService purchaseService;
    private final ItemService itemService;
    private final IamportClient iamportClient;
    private final RedissonClient redissonClient; // Redisson í´ë¼ì´ì–¸íŠ¸ ì£¼ì…
    private final JwtUtil jwtUtil;
    private final IamportConfig iamportConfig;

```

ì´ë ‡ê²Œ ë¦¬íŒ©í† ë§ í•˜ê³ ,
```
package org.hanghae.markethub.domain.purchase.config;

import com.siot.IamportRestClient.IamportClient;
import lombok.Getter;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;


@Configuration
public class IamportConfig {

    @Value("${secret.sec.key}")
    private String secretKey ;
    @Value("${api.api.key}")
    private String apiKey ;

    @Bean
    public IamportClient iamportClient() {
        return new IamportClient(apiKey, secretKey);
    }

    public String getApiKey() {
        return apiKey;
    }
    public String getSecretKey() {
        return secretKey;
    }

}
```

IamportConfig ë¥¼ ì •ì˜í•˜ëŠ”ì‹ìœ¼ë¡œ ë¦¬íŒ©í† ë§ì„ í–ˆë‹¤.

ì´ë•Œ, iamportConfigê°€ ê³„ì† nullë¡œ ì°íˆëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ê²Œ ë˜ì—ˆë‹¤.

ì•ˆë  ì´ìœ ê°€ ì—†ëŠ”ë° ì™œ ì•ˆë ê¹Œ. ë¼ëŠ” ìƒê°ìœ¼ë¡œ 4ì‹œê°„ì •ë„ íˆ¬ìí•´ì„œ ê³„ì† ì•Œì•„ë³´ì•˜ê³ 
ì´ìœ ë¥¼ ì°¾ì•„ëƒˆë‹¤. ë°”ë¡œ AOPì˜ ì‘ë™ ì‹œì ê³¼ ì˜ì¡´ì„± ì£¼ì… ì‹œì ì— ì°¨ì´ê°€ ë°œìƒí•˜ê²Œë˜ë©´ ì˜ë„ì¹˜ì•Šê²Œ ê°’ì´ ë¹ ì§ˆìˆ˜ìˆë‹¤ëŠ”ê²ƒ.

ì¡°ê¸ˆ ë” ìì„¸íˆ ë§í•˜ìë©´

AOP ë¡œì§ì´ @Valueë¡œ ì£¼ì…ëœ í”„ë¡œí¼í‹° ê°’ì— ì ‘ê·¼í•˜ê¸° ì „ì— ì‹¤í–‰ë˜ì–´ ê°’ì„ ì •ìƒì ìœ¼ë¡œ ì°¸ì¡°í•  ìˆ˜ ì—†ëŠ” ìƒí™©ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒ.

ì´ ë¬¸ì œì— ëŒ€í•´ ìì„¸íˆ ì•Œì•„ë³´ë ¤ë©´ ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ì˜ ë¹ˆ(Bean) ìƒëª…ì£¼ê¸°, AOPì˜ ì‘ë™ ë°©ì‹, ê·¸ë¦¬ê³  í”„ë¡œí¼í‹° ê°’ì˜ ì£¼ì… ì‹œì ì— ëŒ€í•´ ì´í•´í•  í•„ìš”ê°€ ìˆë‹¤.

ìŠ¤í”„ë§ ë¹ˆì˜ ìƒëª… ì£¼ê¸°
```
ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì—ì„œì˜ ë¹ˆì˜ ìƒëª…ì£¼ê¸°ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

ë¹ˆ ì¸ìŠ¤í„´ìŠ¤í™”: ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ ë¹ˆì˜ í´ë˜ìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•œë‹¤.
ì˜ì¡´ì„± ì£¼ì…: @Autowired, @Resource, @Value ë“±ì„ í†µí•´ í•„ìš”í•œ ì˜ì¡´ì„±ì„ ì£¼ì…í•œë‹¤.
ì´ˆê¸°í™” ë©”ì„œë“œ ì‹¤í–‰: ì‚¬ìš©ìê°€ ì •ì˜í•œ ì´ˆê¸°í™” ë©”ì„œë“œ(@PostConstruct ë“±)ê°€ ì‹¤í–‰ëœë‹¤.
ë¹ˆ ì‚¬ìš©: ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰ë˜ë©´ì„œ ë¹ˆì´ í•„ìš”í•œ ì‹œì ì— ì‚¬ìš©ëœë‹¤.
ì†Œë©¸ ë©”ì„œë“œ ì‹¤í–‰: ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ë©´ì„œ @PreDestroy ë“±ì˜ ì†Œë©¸ ë©”ì„œë“œê°€ ì‹¤í–‰ëœë‹¤.

AOPì˜ ì‘ë™ ë°©ì‹
AOPëŠ” íŠ¹ì • ë¡œì§(ì–´ë“œë°”ì´ìŠ¤)ì„ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë‹¤ë¥¸ ë¶€ë¶„(ì¡°ì¸ í¬ì¸íŠ¸)ì— ë™ì ìœ¼ë¡œ ì ìš©í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë™ì‘í•œë‹¤.
ìŠ¤í”„ë§ AOPëŠ” ì£¼ë¡œ í”„ë¡ì‹œ íŒ¨í„´ì„ ì‚¬ìš©í•˜ì—¬ êµ¬í˜„ëœë‹¤.
ì´ëŠ” ì‹¤ì œ ê°ì²´ ëŒ€ì‹  í”„ë¡ì‹œ ê°ì²´ë¥¼ ìƒì„±í•˜ê³ , í•´ë‹¹ í”„ë¡ì‹œë¥¼ í†µí•´ ì‹¤ì œ ê°ì²´ì˜ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ, AOP ë¡œì§ì„ ë¼ì›Œ ë„£ëŠ”ë‹¤.

í”„ë¡œí¼í‹° ê°’ì˜ ì£¼ì… ì‹œì 
@Valueë¥¼ ì‚¬ìš©í•œ í”„ë¡œí¼í‹° ê°’ì˜ ì£¼ì…ì€ ì˜ì¡´ì„± ì£¼ì… ë‹¨ê³„ì—ì„œ ì´ë£¨ì–´ì§„ë‹¤.
ì¦‰, ë¹ˆ ì¸ìŠ¤í„´ìŠ¤í™” ì´í›„, ì´ˆê¸°í™” ë©”ì„œë“œ ì‹¤í–‰ ì´ì „ì— ìˆ˜í–‰ëœë‹¤.

ë¬¸ì œ ë°œìƒ ì›ì¸
ë¬¸ì œ ë°œìƒ ì›ì¸ì€ ì•„ë˜ì™€ ê°™ë‹¤.

í”„ë¡ì‹œ ê°ì²´ì™€ ì‹¤ì œ ê°ì²´ ì‚¬ì´ì˜ ì£¼ì… ì‹œì  ì°¨ì´: AOP í”„ë¡ì‹œê°€ ìƒì„±ë˜ëŠ” ì‹œì ê³¼ ì‹¤ì œ ë¹ˆì— @Valueë¡œ ê°’ì´ ì£¼ì…ë˜ëŠ” ì‹œì  ì‚¬ì´ì— ì°¨ì´ê°€ ìˆì„ ë•Œ, AOP ë¡œì§ ì‹¤í–‰ ì‹œì ì— í”„ë¡œí¼í‹° ê°’ì´ ì•„ì§ ì£¼ì…ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆë‹¤.

AOP ì ìš© ëŒ€ìƒ ì„ íƒì˜ ì˜¤ë¥˜: @Aspect ì„¤ì •ì—ì„œ AOP ì ìš© ëŒ€ìƒì„ ì˜ëª» ì§€ì •í•˜ì—¬, ì˜ì¡´ì„± ì£¼ì…ì´ ì™„ë£Œë˜ê¸° ì „ì— AOP ë¡œì§ì´ ì‹¤í–‰ë˜ëŠ” ê²½ìš°ì´ë‹¤.

ë¹ˆì˜ ìƒì„± ë° ì´ˆê¸°í™” ê³¼ì •ì—ì„œì˜ íŠ¹ìˆ˜í•œ ì¼€ì´ìŠ¤: íŠ¹ì • ë¹ˆì˜ ìƒì„± ë° ì´ˆê¸°í™” ê³¼ì •ì—ì„œ AOP ë¡œì§ì´ ì˜ì¡´ì„± ì£¼ì…ë³´ë‹¤ ë¨¼ì € ì‹¤í–‰ë˜ë„ë¡ êµ¬ì„±ëœ ê²½ìš°, ì˜ˆë¥¼ ë“¤ì–´, ì‚¬ìš©ì ì •ì˜ ì´ˆê¸°í™” ë©”ì„œë“œ ë‚´ë¶€ì—ì„œ AOP ë¡œì§ì´ íŠ¸ë¦¬ê±°ë  ë•Œ ë“±ì´ ìˆë‹¤.
```

ì¼ì „ì— í•´ê²°í•œ Valueì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ì¤‘ ë°œìƒí•œ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…ì—ì„œ ì •ë¦¬í•œ ë‚´ìš©ì„ ì°¸ê³ í•´ì„œ ìƒê°í•´ë³´ì.


ë¬¸ì œê°€ ë°œìƒí•œ ì½”ë“œëŠ” ì•„ë˜ì™€ê°™ë‹¤.
```
@PostMapping("/api/payment/cancel")
    private boolean cancelPayment(@RequestBody RefundRequestDto refundRequestDto) throws JsonProcessingException {
        System.out.println("1");
        System.out.println(iamportConfig);
        RestTemplate restTemplate = new RestTemplate();


        String url = "https://api.iamport.kr/payments/cancel";

        // ìš”ì²­ íŒŒë¼ë¯¸í„° ì„¤ì •
        MultiValueMap<String, String> formData = new LinkedMultiValueMap<>();
        formData.add("impUid", refundRequestDto.imp_uid());
        formData.add("checksum", String.valueOf(refundRequestDto.checksum()));
        formData.add("reason", refundRequestDto.reason());


        // ìš”ì²­ í—¤ë” ì„¤ì •
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);
        System.out.println("2");
        String token = getAccessToken(new PaymentRequestDto.getToken(iamportConfig.getApiKey(), iamportConfig.getSecretKey()));
        headers.set("Authorization", "Bearer " + token);

        // ìš”ì²­ ê°ì²´ ìƒì„±
        HttpEntity<MultiValueMap<String, String>> requestEntity = new HttpEntity<>(formData, headers);

        // ìš”ì²­ ë³´ë‚´ê¸°
        ResponseEntity<String> response = restTemplate.postForEntity(url, requestEntity, String.class);

        // ì‘ë‹µ ì²˜ë¦¬
        if (response.getStatusCode() == HttpStatus.OK) {
            // ê° ì•„ì´í…œì— ëŒ€í•´ ìˆ˜ëŸ‰ ë¡¤ë°± ì§„í–‰
            purchaseService.rollbackItemsQuantity(refundRequestDto.imp_uid());
            // ì£¼ë¬¸ ìƒíƒœ ë³€ê²½
            purchaseService.ChangeStatusToCancelled(refundRequestDto.imp_uid());
            return true;
        } else {
            return false;
        }
    }
```
String token = getAccessToken(new PaymentRequestDto.getToken(iamportConfig.getApiKey(), iamportConfig.getSecretKey()));

ì—¬ê¸°ì„œ iamportConfigê°€ ê³„ì† nullì´ì—ˆë‹¤.

ìœ„ì—ì„œ ì•Œì•„ë³¸ ë°”ì— ë”°ë¥´ë©´,

AOPê°€ ì‹¤í–‰ë˜ëŠ” ì‹œì ì€ ìƒˆë¡œìš´ PaymentRequestDto ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë˜ê¸° ì „ ì´ë¯€ë¡œ
AOP í”„ë¡ì‹œ ê°ì²´ê°€ cancelPaymentë¥¼ ê°ìŒ€ë•Œ PaymentRequestDtoëŠ” nullì´ê²Œ ëœë‹¤.

ê·¸ í›„, í”„ë¡ì‹œ ê°ì²´ê°€ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— nullì¸ì±„ë¡œ ì‹¤í–‰ë˜ëŠ”ê±°ì§€.

AOPë¥¼ ì ìš©í• ë•Œ í”„ë¡œí¼í‹°ì˜ ì ìš© ì‹œì ì— ëŒ€í•´ì„œ ì˜ ìƒê°í•˜ê³  ì ìš©í•´ì•¼í• ê±°ê°™ë‹¤.

í•­ìƒ ëŠë¼ëŠ”ê±´ë°, ì „ì—­ìœ¼ë¡œ ë¬´ì–¸ê°€ë¥¼ ì ìš©í•œë‹¤ë©´ ë‚´ê°€ ì˜ˆìƒí•˜ì§€ëª»í•œ ë™ì‘ì„ í•  ê°€ëŠ¥ì„±ì´ í•­ìƒ ì¡´ì¬í•˜ëŠ”ê²ƒ ê°™ë‹¤.

ë‚œ ì´ ë¶ˆí™•ì‹¤ì„±ì´ ì‹«ë‹¤. globalì ì¸ ë¬´ì–¸ê°€ë¥¼ ì¶”ê°€í• ë•ŒëŠ” ì •ë§ ë§ì€ê±¸ ê³ ë ¤í•´ì•¼í•˜ëŠ”ê²ƒ ê°™ë‹¤.
</details>
